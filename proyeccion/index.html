<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis Estadístico de Inventario y Bodega</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        table { border-collapse: collapse; width: 100%; font-size: 0.85rem; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; }
        th { background-color: #f3f4f6; position: sticky; top: 0; }
        .q-col { background-color: #f8fafc; }
        .proj-col { background-color: #ecfdf5; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-4 text-blue-800">Análisis de Recurrencia e Inventario</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="p-4 border rounded bg-gray-50">
                <label class="block font-semibold mb-2">1. Base de Inventario (RadGridExport.xlsx)</label>
                <input type="file" id="fileExcel" accept=".xlsx, .xls" class="block w-full text-sm">
            </div>
            
            <div class="p-4 border rounded bg-gray-50">
                <label class="block font-semibold mb-2">2. Salidas de Bodega (salidas_bodega.csv)</label>
                <input type="file" id="fileCsv" accept=".csv" class="block w-full text-sm">
            </div>
        </div>

        <button id="btnProcesar" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mb-6 w-full md:w-auto">
            Procesar y Calcular Cuartiles
        </button>

        <div class="overflow-x-auto" style="max-height: 600px;">
            <table id="resultTable" class="min-w-full hidden">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Cant.</th>
                        <th class="q-col" title="Cuartiles de fechas de compra">Q0 Compra (Min)</th>
                        <th class="q-col">Q1 Compra</th>
                        <th class="q-col">Q2 Compra (Mediana)</th>
                        <th class="q-col">Q3 Compra</th>
                        <th class="q-col">Q4 Compra (Max)</th>
                        <th>Veces Usado</th>
                        <th>Primera Salida</th>
                        <th>Última Salida</th>
                        <th class="q-col" title="Cuartiles de días entre salidas">Q0 Días (Min)</th>
                        <th class="q-col">Q1 Días</th>
                        <th class="q-col">Q2 Días (Mediana)</th>
                        <th class="q-col">Q3 Días</th>
                        <th class="q-col">Q4 Días (Max)</th>
                        <th class="proj-col">Proyección Sig. Compra</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Expresión regular para el formato x-xxx-xx-xxx (alfanumérico)
        const codeRegex = /^[A-Za-z0-9]-[A-Za-z0-9]{3}-[A-Za-z0-9]{2}-[A-Za-z0-9]{3}$/;

        // Función matemática para calcular percentiles/cuartiles
        function calcularCuartil(arr, q) {
            if (arr.length === 0) return null;
            if (arr.length === 1) return arr[0];
            
            const ordenado = [...arr].sort((a, b) => a - b);
            const pos = (ordenado.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            
            if (ordenado[base + 1] !== undefined) {
                return ordenado[base] + rest * (ordenado[base + 1] - ordenado[base]);
            } else {
                return ordenado[base];
            }
        }

        // Obtener Q0 a Q4 de un arreglo de números
        function obtenerCincoCuartiles(arr) {
            if (!arr || arr.length === 0) return [null, null, null, null, null];
            return [
                calcularCuartil(arr, 0),    // Q0 (Min)
                calcularCuartil(arr, 0.25), // Q1
                calcularCuartil(arr, 0.50), // Q2 (Mediana)
                calcularCuartil(arr, 0.75), // Q3
                calcularCuartil(arr, 1)     // Q4 (Max)
            ];
        }

        function formatFecha(timestamp) {
            if (!timestamp) return "N/A";
            const d = new Date(timestamp);
            return d.toLocaleDateString('es-GT');
        }

        function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    // raw: false asegura que las fechas se formateen mejor
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    resolve(jsonData);
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function leerCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: reject
                });
            });
        }

        document.getElementById('btnProcesar').addEventListener('click', async () => {
            const fileExcel = document.getElementById('fileExcel').files[0];
            const fileCsv = document.getElementById('fileCsv').files[0];

            if (!fileExcel || !fileCsv) {
                alert("Por favor, selecciona ambos archivos.");
                return;
            }

            try {
                // 1. Procesar Excel (Inventario/Compras)
                const datosInventario = await leerExcel(fileExcel);
                let inventarioFiltrado = {};

                datosInventario.forEach(row => {
                    // Adaptar las claves según los nombres reales de las columnas en tu Excel.
                    // Buscamos claves que contengan "cod", "desc", "cant", "fecha"
                    let codigo = Object.values(row).find(v => typeof v === 'string' && codeRegex.test(v.trim()));
                    if (!codigo) return;
                    codigo = codigo.trim();

                    let desc = row['Descripción'] || row['Descripcion'] || row['Description'] || "Sin descripción";
                    let cant = row['Cantidad'] || row['Cant'] || row['Qty'] || 0;
                    
                    // Extraer fechas de compra (si hay múltiples filas del mismo código, las agrupamos)
                    let fechaCompraRaw = row['Fecha de última compra'] || row['Fecha Compra'] || row['Fecha'];
                    let fechaCompra = fechaCompraRaw ? new Date(fechaCompraRaw).getTime() : null;

                    if (!inventarioFiltrado[codigo]) {
                        inventarioFiltrado[codigo] = {
                            codigo,
                            descripcion: desc,
                            cantidad: parseFloat(cant),
                            fechasCompra: []
                        };
                    }
                    if (fechaCompra) inventarioFiltrado[codigo].fechasCompra.push(fechaCompra);
                });

                // 2. Procesar CSV (Salidas)
                const datosSalidas = await leerCSV(fileCsv);
                let salidasPorCodigo = {};

                datosSalidas.forEach(row => {
                    let codigo = Object.values(row).find(v => typeof v === 'string' && codeRegex.test(v.trim()));
                    if (!codigo) return;
                    codigo = codigo.trim();

                    let fechaSalidaRaw = row['Fecha'] || row['Date'] || Object.values(row)[1]; // Ajustar índice o nombre si varía
                    let fechaSalida = new Date(fechaSalidaRaw).getTime();

                    if (!isNaN(fechaSalida)) {
                        if (!salidasPorCodigo[codigo]) salidasPorCodigo[codigo] = [];
                        salidasPorCodigo[codigo].push(fechaSalida);
                    }
                });

                // 3. Cruzar datos y calcular
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = ""; // Limpiar tabla

                Object.keys(inventarioFiltrado).forEach(codigo => {
                    const inv = inventarioFiltrado[codigo];
                    const salidas = (salidasPorCodigo[codigo] || []).sort((a, b) => a - b);
                    
                    // Cuartiles de fecha de compra (convirtiendo timestamps a fechas)
                    const qFechasCompra = obtenerCincoCuartiles(inv.fechasCompra);
                    
                    // Análisis de recurrencia de salidas
                    let vecesUsado = salidas.length;
                    let primeraSalida = vecesUsado > 0 ? salidas[0] : null;
                    let ultimaSalida = vecesUsado > 0 ? salidas[salidas.length - 1] : null;
                    
                    // Calcular tiempo entre salidas en DÍAS
                    let diasEntreSalidas = [];
                    for (let i = 1; i < salidas.length; i++) {
                        let diffMs = salidas[i] - salidas[i-1];
                        let diffDias = diffMs / (1000 * 60 * 60 * 24);
                        diasEntreSalidas.push(diffDias);
                    }
                    
                    const qDiasSalidas = obtenerCincoCuartiles(diasEntreSalidas);
                    
                    // Proyección si cantidad es <= 1
                    let proyeccion = "N/A";
                    if (inv.cantidad <= 1 && ultimaSalida && qDiasSalidas[2] !== null) { // qDiasSalidas[2] es la mediana
                        let diasMediana = qDiasSalidas[2];
                        let fechaProyectadaMs = ultimaSalida + (diasMediana * 1000 * 60 * 60 * 24);
                        proyeccion = formatFecha(fechaProyectadaMs);
                    }

                    // Renderizar fila
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="font-bold">${inv.codigo}</td>
                        <td>${inv.descripcion}</td>
                        <td class="text-right">${inv.cantidad}</td>
                        <td class="q-col">${formatFecha(qFechasCompra[0])}</td>
                        <td class="q-col">${formatFecha(qFechasCompra[1])}</td>
                        <td class="q-col">${formatFecha(qFechasCompra[2])}</td>
                        <td class="q-col">${formatFecha(qFechasCompra[3])}</td>
                        <td class="q-col">${formatFecha(qFechasCompra[4])}</td>
                        <td class="text-center">${vecesUsado}</td>
                        <td>${formatFecha(primeraSalida)}</td>
                        <td>${formatFecha(ultimaSalida)}</td>
                        <td class="q-col text-right">${qDiasSalidas[0] !== null ? qDiasSalidas[0].toFixed(1) : '-'}</td>
                        <td class="q-col text-right">${qDiasSalidas[1] !== null ? qDiasSalidas[1].toFixed(1) : '-'}</td>
                        <td class="q-col text-right">${qDiasSalidas[2] !== null ? qDiasSalidas[2].toFixed(1) : '-'}</td>
                        <td class="q-col text-right">${qDiasSalidas[3] !== null ? qDiasSalidas[3].toFixed(1) : '-'}</td>
                        <td class="q-col text-right">${qDiasSalidas[4] !== null ? qDiasSalidas[4].toFixed(1) : '-'}</td>
                        <td class="proj-col">${proyeccion}</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('resultTable').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("Ocurrió un error al procesar los archivos. Revisa el formato de los datos e intenta nuevamente.");
            }
        });
    </script>
</body>
</html>
