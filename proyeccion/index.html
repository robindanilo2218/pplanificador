<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An√°lisis Estad√≠stico de Inventario y Bodega</title>
    
    <!-- Enlaces PWA -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./icon.svg">
    <meta name="theme-color" content="#2563eb">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        table { border-collapse: collapse; width: 100%; font-size: 0.85rem; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: left; white-space: nowrap; }
        th { background-color: #f3f4f6; position: sticky; top: 0; z-index: 20; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .q-col { background-color: #f8fafc; }
        .proj-col { background-color: #ecfdf5; font-weight: bold; }
        .dest-col { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .badge { padding: 0.25rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-align: center; display: inline-block; width: 100px;}
        .sortable-header { cursor: pointer; user-select: none; transition: background-color 0.2s; }
        .sortable-header:hover { background-color: #d1fae5; }
        
        @media print {
            body { background-color: white !important; padding: 0 !important; }
            .no-print { display: none !important; }
            .max-w-[1400px] { max-width: 100% !important; box-shadow: none !important; padding: 0 !important; margin: 0 !important; }
            .overflow-x-auto { overflow: visible !important; max-height: none !important; }
            table { font-size: 0.65rem; width: 100%; page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { padding: 4px; border: 1px solid #cbd5e1; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 p-2 md:p-6">

    <div class="max-w-[1400px] mx-auto bg-white p-3 md:p-6 rounded-lg shadow-md">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <h1 class="text-2xl font-bold text-blue-800">An√°lisis de Rotaci√≥n e Inventario</h1>
            
            <div id="controlesSesion" class="hidden flex flex-wrap gap-2 no-print">
                <button id="btnImprimirPdf" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-4 rounded text-sm transition shadow-sm">
                    üñ®Ô∏è PDF / Imprimir
                </button>
                <button id="btnExportarExcel" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-4 rounded text-sm transition shadow-sm">
                    üìä Exportar Excel
                </button>
                <div class="w-px bg-gray-300 mx-1"></div>
                <button id="btnMostrarImportar" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-4 rounded text-sm transition">
                    üîÑ Actualizar Datos
                </button>
                <button id="btnActualizarApp" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-semibold py-1 px-4 rounded text-sm transition border border-purple-300" title="Descarga la √∫ltima versi√≥n del sistema sin borrar tus datos">
                    ‚ú® Actualizar App
                </button>
                <button id="btnBorrarDatos" class="bg-red-100 hover:bg-red-200 text-red-700 font-semibold py-1 px-4 rounded text-sm transition border border-red-300" title="Borra los datos guardados en este dispositivo">
                    üóëÔ∏è Borrar Todo
                </button>
            </div>
        </div>
        
        <div id="zonaImportacion" class="mb-6 transition-all duration-300 no-print">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                <div class="p-4 border rounded bg-gray-50">
                    <label class="block font-semibold mb-2 text-sm">1. Base de Inventario (RadGridExport.xlsx)</label>
                    <input type="file" id="fileExcel" accept=".xlsx, .xls" class="block w-full text-sm">
                </div>
                
                <div class="p-4 border rounded bg-gray-50">
                    <label class="block font-semibold mb-2 text-sm">2. Salidas de Bodega (salidas_bodega.csv)</label>
                    <input type="file" id="fileCsv" accept=".csv" class="block w-full text-sm">
                </div>
            </div>
            <button id="btnProcesar" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded w-full md:w-auto h-10 shadow-sm transition">
                Procesar y Guardar
            </button>
        </div>

        <div class="w-full border p-4 rounded bg-gray-50 hidden mb-6 no-print shadow-sm" id="contenedorFiltros">
            
            <!-- BUSCADOR DE TEXTO -->
            <div class="w-full mb-4">
                <label for="busquedaTexto" class="font-semibold text-sm mb-1 block text-gray-700">Buscador General:</label>
                <input type="text" id="busquedaTexto" placeholder="üîç Buscar por c√≥digo, n√∫mero de parte o descripci√≥n..." 
                       class="w-full border-gray-300 border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
            </div>

            <!-- FILTROS DESPLEGABLES -->
            <div class="flex flex-wrap items-center gap-4 w-full">
                <div>
                    <label class="font-semibold mr-1 text-xs text-gray-600">Grupo:</label>
                    <select id="filtroGrupo" class="border-gray-300 border rounded p-1 text-xs bg-white cursor-pointer w-28">
                        <option value="todos">Todos</option>
                    </select>
                </div>
                <div>
                    <label class="font-semibold mr-1 text-xs text-gray-600">M√°quina:</label>
                    <select id="filtroMaquina" class="border-gray-300 border rounded p-1 text-xs bg-white cursor-pointer w-32">
                        <option value="todas">Todas</option>
                    </select>
                </div>
                <div>
                    <label class="font-semibold mr-1 text-xs text-gray-600">Stock:</label>
                    <select id="filtroStock" class="border-gray-300 border rounded p-1 text-xs bg-white cursor-pointer w-28">
                        <option value="todos">Todos</option>
                        <option value="cero">Solo = 0</option>
                        <option value="uno">Solo = 1</option>
                        <option value="resto">Resto (>1)</option>
                    </select>
                </div>
                <div>
                    <label class="font-semibold mr-1 text-xs text-gray-600">Estado:</label>
                    <select id="filtroEstado" class="border-gray-300 border rounded p-1 text-xs bg-white cursor-pointer w-32">
                        <option value="todos">Todos</option>
                        <option value="Activo">Activos</option>
                        <option value="Moderado">Moderados</option>
                        <option value="Inactivo">Inactivos</option>
                        <option value="Sin movimiento">Sin Mov.</option>
                    </select>
                </div>
                <div>
                    <label class="font-semibold mr-1 text-xs text-gray-600">Proyecci√≥n:</label>
                    <select id="filtroProyeccion" class="border-gray-300 border rounded p-1 text-xs bg-white cursor-pointer w-32">
                        <option value="todas">Todas</option>
                        <option value="este_mes">Este mes</option>
                        <option value="mes_anterior">Mes anterior</option>
                        <option value="este_anio">Este a√±o</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="overflow-auto w-full border border-gray-200 rounded-md" style="max-height: 70vh; -webkit-overflow-scrolling: touch;">
            <table id="resultTable" class="min-w-full hidden bg-white">
                <thead>
                    <tr>
                        <th>C√≥digo</th>
                        <th>Descripci√≥n</th>
                        <th>Cant.</th>
                        <th>Destinos / M√°quinas</th>
                        <th>√öltima Compra</th>
                        <th class="text-center">Estado (Rotaci√≥n)</th>
                        <th>Veces Usado</th>
                        <th>Primera Salida</th>
                        <th>√öltima Salida</th>
                        <th class="q-col" title="Cuartiles de d√≠as entre salidas">Q0 D√≠as</th>
                        <th class="q-col">Q1 D√≠as</th>
                        <th class="q-col">Q2 D√≠as (Med)</th>
                        <th class="q-col">Q3 D√≠as</th>
                        <th class="q-col">Q4 D√≠as</th>
                        <th class="proj-col sortable-header no-print" id="thSortProyeccion" title="Clic para ordenar cronol√≥gicamente">
                            Proyecci√≥n Sig. Compra <span id="sortIcon">‚ÜïÔ∏è</span>
                        </th>
                        <th class="proj-col hidden print:table-cell">Proyecci√≥n Sig. Compra</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // Registro del Service Worker para funcionamiento Offline PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Solo intentar registrar si estamos en un servidor web (http o https)
                if (window.location.protocol === 'http:' || window.location.protocol === 'https:') {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('PWA Service Worker registrado correctamente.', reg.scope))
                        .catch(err => console.error('Error al registrar PWA:', err));
                } else {
                    console.log('Service Worker omitido: Se requiere un servidor web (http/https) para instalar la PWA. Protocolo actual:', window.location.protocol);
                }
            });
        }

        const codeRegex = /^[A-Za-z0-9]-[A-Za-z0-9]{3}-[A-Za-z0-9]{2}-[A-Za-z0-9]{3}$/;
        const LOCAL_STORAGE_KEY = 'bodegaAnalisisData';

        function calcularCuartil(arr, q) {
            const ordenado = [...arr].sort((a, b) => a - b);
            const pos = (ordenado.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            return (ordenado[base + 1] !== undefined) ? ordenado[base] + rest * (ordenado[base + 1] - ordenado[base]) : ordenado[base];
        }

        function obtenerCincoCuartiles(arr) {
            if (!arr || arr.length === 0) return [null, null, null, null, null];
            if (arr.length === 1) return [arr[0], arr[0], arr[0], arr[0], arr[0]];
            if (arr.length === 2) {
                const min = Math.min(arr[0], arr[1]);
                const max = Math.max(arr[0], arr[1]);
                const media = (min + max) / 2;
                return [min, min, media, max, max];
            }
            return [calcularCuartil(arr, 0), calcularCuartil(arr, 0.25), calcularCuartil(arr, 0.50), calcularCuartil(arr, 0.75), calcularCuartil(arr, 1)];
        }

        function formatFecha(timestamp) {
            if (!timestamp) return "N/A";
            const d = new Date(timestamp);
            const localDate = new Date(d.getTime() + d.getTimezoneOffset() * 60000);
            return localDate.toLocaleDateString('es-GT');
        }

        function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                    resolve(XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function leerCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, { header: true, skipEmptyLines: true, complete: (results) => resolve(results.data), error: reject });
            });
        }

        function aplicarFiltros() {
            const fBusqueda = document.getElementById('busquedaTexto').value.toLowerCase().trim();
            const fStock = document.getElementById('filtroStock').value;
            const fProy = document.getElementById('filtroProyeccion').value;
            const fGrupo = document.getElementById('filtroGrupo').value;
            const fMaquina = document.getElementById('filtroMaquina').value;
            const fEstado = document.getElementById('filtroEstado').value;
            
            const filas = document.querySelectorAll('.data-row');
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();

            filas.forEach(fila => {
                const codigoTxt = fila.getAttribute('data-codigo');
                const descTxt = fila.getAttribute('data-desc');
                const stock = parseFloat(fila.getAttribute('data-stock'));
                const proyMs = fila.getAttribute('data-proyeccion-ms');
                const grupo = fila.getAttribute('data-grupo');
                const maquinas = fila.getAttribute('data-maquinas').toLowerCase();
                const estado = fila.getAttribute('data-estado');
                
                let mostrar = true;
                
                // 1. Filtro de Texto Libre (Buscador)
                if (fBusqueda !== "") {
                    if (!codigoTxt.includes(fBusqueda) && !descTxt.includes(fBusqueda)) {
                        mostrar = false;
                    }
                }

                // 2. Filtros Desplegables
                if (mostrar && fGrupo !== 'todos' && grupo !== fGrupo) mostrar = false;
                if (mostrar && fMaquina !== 'todas' && !maquinas.includes(fMaquina.toLowerCase())) mostrar = false;
                if (mostrar && fEstado !== 'todos' && estado !== fEstado) mostrar = false;

                if (mostrar) {
                    if (fStock === 'cero' && stock !== 0) mostrar = false;
                    else if (fStock === 'uno' && stock !== 1) mostrar = false;
                    else if (fStock === 'resto' && stock <= 1) mostrar = false;
                }
                
                if (mostrar && fProy !== 'todas') {
                    if (!proyMs) mostrar = false; 
                    else {
                        const dProy = new Date(parseFloat(proyMs));
                        if (fProy === 'este_mes' && (dProy.getFullYear() !== currentYear || dProy.getMonth() !== currentMonth)) mostrar = false;
                        else if (fProy === 'mes_anterior') {
                            let lastMonth = currentMonth - 1; let lastYear = currentYear;
                            if (lastMonth < 0) { lastMonth = 11; lastYear--; }
                            if (dProy.getFullYear() !== lastYear || dProy.getMonth() !== lastMonth) mostrar = false;
                        } 
                        else if (fProy === 'este_anio' && dProy.getFullYear() !== currentYear) mostrar = false;
                    }
                }
                fila.style.display = mostrar ? '' : 'none';
            });
        }

        // Listeners para todos los filtros
        ['filtroStock', 'filtroProyeccion', 'filtroGrupo', 'filtroMaquina', 'filtroEstado'].forEach(id => {
            document.getElementById(id).addEventListener('change', aplicarFiltros);
        });
        
        // Listener para el buscador de texto en tiempo real
        document.getElementById('busquedaTexto').addEventListener('input', aplicarFiltros);

        // Ordenamiento
        let sortAscendente = true; 
        document.getElementById('thSortProyeccion').addEventListener('click', () => {
            const tbody = document.getElementById('tableBody');
            const filas = Array.from(tbody.querySelectorAll('.data-row'));

            filas.sort((a, b) => {
                const valA = a.getAttribute('data-proyeccion-ms');
                const valB = b.getAttribute('data-proyeccion-ms');
                if (!valA && !valB) return 0;
                if (!valA) return 1; 
                if (!valB) return -1;
                return sortAscendente ? parseFloat(valA) - parseFloat(valB) : parseFloat(valB) - parseFloat(valA);
            });

            filas.forEach(fila => tbody.appendChild(fila));
            sortAscendente = !sortAscendente;
            document.getElementById('sortIcon').innerText = sortAscendente ? 'üîº' : 'üîΩ';
        });

        // Exportaci√≥n
        document.getElementById('btnImprimirPdf').addEventListener('click', () => { window.print(); });

        document.getElementById('btnExportarExcel').addEventListener('click', () => {
            const tablaOriginal = document.getElementById('resultTable');
            const filasVisibles = Array.from(tablaOriginal.querySelectorAll('tr')).filter(fila => fila.style.display !== 'none');
            
            const datosLimpios = [];
            filasVisibles.forEach(fila => {
                const rowData = [];
                const celdas = Array.from(fila.querySelectorAll('th, td')).filter(celda => !celda.classList.contains('hidden'));
                celdas.forEach(celda => {
                    let texto = celda.innerText.replace('‚ÜïÔ∏è', '').replace('üîº', '').replace('üîΩ', '').trim();
                    rowData.push(texto);
                });
                datosLimpios.push(rowData);
            });

            const hoja = XLSX.utils.aoa_to_sheet(datosLimpios);
            const libro = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(libro, hoja, "Bodega_Analisis");
            
            const fecha = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(libro, `Analisis_Bodega_${fecha}.xlsx`);
        });

        // Renderizado Base
        function renderizarTablaYFiltros(datos) {
            const { resultadosTabla, gruposUnicos, maquinasUnicas } = datos;

            const selGrupo = document.getElementById('filtroGrupo');
            const selMaquina = document.getElementById('filtroMaquina');
            selGrupo.innerHTML = '<option value="todos">Todos</option>';
            gruposUnicos.sort().forEach(g => selGrupo.innerHTML += `<option value="${g}">${g}</option>`);
            selMaquina.innerHTML = '<option value="todas">Todas</option>';
            maquinasUnicas.sort().forEach(m => selMaquina.innerHTML += `<option value="${m}">${m}</option>`);

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ""; 

            resultadosTabla.forEach(fila => {
                const { inv, maquinasUnicas, estado, estadoClase, vecesUsado, primeraSalida, ultimaSalida, qDiasSalidas, proyeccionTexto, proyeccionMs } = fila;
                const tr = document.createElement('tr');
                tr.className = "data-row hover:bg-gray-100 transition duration-150";
                tr.setAttribute("data-stock", inv.cantidad);
                tr.setAttribute("data-proyeccion-ms", proyeccionMs || "");
                tr.setAttribute("data-grupo", inv.grupo);
                tr.setAttribute("data-maquinas", maquinasUnicas);
                tr.setAttribute("data-estado", estado); 
                // Atributos de b√∫squeda para texto libre
                tr.setAttribute("data-codigo", inv.codigo.toLowerCase());
                tr.setAttribute("data-desc", inv.descripcion.toLowerCase());
                
                tr.innerHTML = `
                    <td class="font-bold">${inv.codigo}</td>
                    <td class="text-xs">${inv.descripcion}</td>
                    <td class="text-center font-bold text-blue-900 bg-blue-50">${inv.cantidad}</td>
                    <td class="dest-col text-xs" title="${maquinasUnicas}">${maquinasUnicas}</td>
                    <td class="text-xs font-semibold text-gray-700">${formatFecha(inv.ultimaCompra)}</td>
                    <td class="text-center"><span class="badge ${estadoClase}">${estado}</span></td>
                    <td class="text-center font-bold">${vecesUsado}</td>
                    <td class="text-xs">${formatFecha(primeraSalida)}</td>
                    <td class="text-xs">${formatFecha(ultimaSalida)}</td>
                    <td class="q-col text-right">${qDiasSalidas[0] !== null ? qDiasSalidas[0].toFixed(1) : '-'}</td>
                    <td class="q-col text-right">${qDiasSalidas[1] !== null ? qDiasSalidas[1].toFixed(1) : '-'}</td>
                    <td class="q-col text-right font-bold text-red-600">${qDiasSalidas[2] !== null ? qDiasSalidas[2].toFixed(1) : '-'}</td>
                    <td class="q-col text-right">${qDiasSalidas[3] !== null ? qDiasSalidas[3].toFixed(1) : '-'}</td>
                    <td class="q-col text-right">${qDiasSalidas[4] !== null ? qDiasSalidas[4].toFixed(1) : '-'}</td>
                    <td class="proj-col text-sm no-print">${proyeccionTexto}</td>
                    <td class="proj-col text-sm hidden print:table-cell">${proyeccionTexto}</td>
                `;
                tbody.appendChild(tr);
            });

            document.getElementById('resultTable').classList.remove('hidden');
            document.getElementById('contenedorFiltros').classList.remove('hidden');
            document.getElementById('zonaImportacion').classList.add('hidden');
            document.getElementById('controlesSesion').classList.remove('hidden');
            
            aplicarFiltros();
        }

        // Procesamiento Principal
        document.getElementById('btnProcesar').addEventListener('click', async () => {
            const fileExcel = document.getElementById('fileExcel').files[0];
            const fileCsv = document.getElementById('fileCsv').files[0];

            if (!fileExcel || !fileCsv) { alert("Por favor, selecciona ambos archivos."); return; }

            sortAscendente = true;
            document.getElementById('sortIcon').innerText = '‚ÜïÔ∏è';
            document.getElementById('btnProcesar').innerText = "Procesando...";

            try {
                const setGrupos = new Set();
                const setMaquinas = new Set();
                const todasLasSalidasGlobales = []; 

                // 1. Procesar Excel 
                const datosInventario = await leerExcel(fileExcel);
                let inventarioFiltrado = {};

                datosInventario.forEach(row => {
                    let codigo = Object.values(row).find(v => typeof v === 'string' && codeRegex.test(v.trim()));
                    if (!codigo) return; codigo = codigo.trim();

                    let partes = codigo.split('-');
                    let grupoCodigo = partes[0] + '-' + partes[1];
                    setGrupos.add(grupoCodigo);

                    let descKey = Object.keys(row).find(k => {
                        let kl = k.toLowerCase().trim();
                        return kl.includes('desc') || kl.includes('nomb') || kl.includes('art');
                    });
                    let desc = descKey ? row[descKey] : "Sin descripci√≥n";

                    let cantKey = Object.keys(row).find(k => {
                        let kl = k.toLowerCase().trim();
                        return kl.includes('cant') || kl.includes('exist') || kl.includes('stock') || kl.includes('disp') || kl.includes('saldo');
                    });
                    
                    let cantRaw = cantKey ? row[cantKey] : 0;
                    let cant = parseFloat(String(cantRaw).replace(/,/g, '').trim());
                    if (isNaN(cant)) cant = 0;
                    
                    let fechaKey = Object.keys(row).find(k => {
                        let kl = k.toLowerCase().trim();
                        return kl.includes('fecha') || kl.includes('date') || kl.includes('√∫lt') || kl.includes('ult');
                    });
                    let fechaCompraRaw = fechaKey ? row[fechaKey] : null;
                    let fechaCompra = fechaCompraRaw ? new Date(fechaCompraRaw).getTime() : null;

                    if (!inventarioFiltrado[codigo]) {
                        inventarioFiltrado[codigo] = { codigo, grupo: grupoCodigo, descripcion: desc, cantidad: cant, ultimaCompra: fechaCompra };
                    } else if (fechaCompra && (!inventarioFiltrado[codigo].ultimaCompra || fechaCompra > inventarioFiltrado[codigo].ultimaCompra)) {
                        inventarioFiltrado[codigo].ultimaCompra = fechaCompra;
                        inventarioFiltrado[codigo].cantidad = cant;
                    }
                });

                // 2. Procesar CSV
                const datosSalidas = await leerCSV(fileCsv);
                let salidasPorCodigo = {};
                let maquinasPorCodigo = {};

                datosSalidas.forEach(row => {
                    let codigo = Object.values(row).find(v => typeof v === 'string' && codeRegex.test(v.trim()));
                    if (!codigo) return; codigo = codigo.trim();

                    let fechaSalidaRaw = row['Fecha'] || row['Date'] || Object.values(row)[1]; 
                    let fechaSalida = new Date(fechaSalidaRaw).getTime();
                    let maquina = (row['M√°quina'] || row['Maquina'] || row['Destino'] || row['Secci√≥n'] || row['Seccion'] || row['√Årea'] || row['Equipo'] || "").trim();
                    if (maquina) setMaquinas.add(maquina);

                    if (!isNaN(fechaSalida)) {
                        if (!salidasPorCodigo[codigo]) salidasPorCodigo[codigo] = [];
                        salidasPorCodigo[codigo].push(fechaSalida);
                        todasLasSalidasGlobales.push(fechaSalida); 
                        if (!maquinasPorCodigo[codigo]) maquinasPorCodigo[codigo] = new Set();
                        if (maquina) maquinasPorCodigo[codigo].add(maquina);
                    }
                });

                const qGlobales = obtenerCincoCuartiles(todasLasSalidasGlobales);
                const limiteInactivo = qGlobales[1]; const limiteActivo = qGlobales[3];   

                // 3. Preparar datos
                let resultadosTabla = [];

                Object.keys(inventarioFiltrado).forEach(codigo => {
                    const inv = inventarioFiltrado[codigo];
                    const salidas = (salidasPorCodigo[codigo] || []).sort((a, b) => a - b);
                    const maquinasUnicas = maquinasPorCodigo[codigo] ? Array.from(maquinasPorCodigo[codigo]).join(", ") : "-";
                    
                    let vecesUsado = salidas.length;
                    let primeraSalida = vecesUsado > 0 ? salidas[0] : null;
                    let ultimaSalida = vecesUsado > 0 ? salidas[salidas.length - 1] : null;

                    let estado = "Sin movimiento"; let estadoClase = "bg-gray-200 text-gray-700"; 
                    if (ultimaSalida) {
                        if (ultimaSalida >= limiteActivo) { estado = "Activo"; estadoClase = "bg-green-100 text-green-800"; } 
                        else if (ultimaSalida >= limiteInactivo) { estado = "Moderado"; estadoClase = "bg-yellow-100 text-yellow-800"; } 
                        else { estado = "Inactivo"; estadoClase = "bg-red-100 text-red-800"; }
                    }
                    
                    let diasEntreSalidas = [];
                    for (let i = 1; i < salidas.length; i++) diasEntreSalidas.push((salidas[i] - salidas[i-1]) / 86400000);
                    
                    const qDiasSalidas = obtenerCincoCuartiles(diasEntreSalidas);
                    let proyeccionMs = ""; let proyeccionTexto = "N/A";
                    
                    if (inv.cantidad <= 1 && ultimaSalida && qDiasSalidas[2] !== null) { 
                        let fechaProyectadaMsLocal = ultimaSalida + (qDiasSalidas[2] * 86400000);
                        proyeccionMs = fechaProyectadaMsLocal;
                        proyeccionTexto = formatFecha(fechaProyectadaMsLocal);
                    }

                    resultadosTabla.push({ inv, maquinasUnicas, estado, estadoClase, vecesUsado, primeraSalida, ultimaSalida, qDiasSalidas, proyeccionTexto, proyeccionMs });
                });

                resultadosTabla.sort((a, b) => (b.ultimaSalida || 0) - (a.ultimaSalida || 0));

                const datosParaGuardar = {
                    resultadosTabla,
                    gruposUnicos: Array.from(setGrupos),
                    maquinasUnicas: Array.from(setMaquinas)
                };

                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(datosParaGuardar));
                } catch (e) {
                    console.warn("No se pudo guardar en LocalStorage.", e);
                }

                renderizarTablaYFiltros(datosParaGuardar);
                document.getElementById('btnProcesar').innerText = "Procesar y Guardar";

            } catch (error) {
                console.error(error);
                alert("Ocurri√≥ un error al procesar los archivos.");
                document.getElementById('btnProcesar').innerText = "Procesar y Guardar";
            }
        });

        document.getElementById('btnBorrarDatos').addEventListener('click', () => {
            if(confirm("¬øEst√°s seguro de que quieres borrar los datos guardados de esta sesi√≥n?")) {
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                location.reload(); 
            }
        });

        // Bot√≥n para Forzar Actualizaci√≥n de la PWA (Borra cach√©, conserva LocalStorage)
        document.getElementById('btnActualizarApp').addEventListener('click', () => {
            if(confirm("¬øBuscar e instalar una nueva versi√≥n de la aplicaci√≥n? \n\nTus datos guardados NO se perder√°n.")) {
                if ('serviceWorker' in navigator && caches) {
                    // 1. Limpiar todas las cach√©s del Service Worker
                    caches.keys().then(names => {
                        return Promise.all(names.map(name => caches.delete(name)));
                    }).then(() => {
                        // 2. Desregistrar los Service Workers activos
                        navigator.serviceWorker.getRegistrations().then(registrations => {
                            let unregisterPromises = registrations.map(registration => registration.unregister());
                            return Promise.all(unregisterPromises);
                        }).then(() => {
                            // 3. Recargar la p√°gina forzando la red (agregando un timestamp para evitar cach√© del navegador)
                            window.location.href = window.location.pathname + '?updated=' + new Date().getTime();
                        });
                    }).catch(err => {
                        console.error("Error al actualizar la app:", err);
                        window.location.reload();
                    });
                } else {
                    // Fallback si no hay SW activo
                    window.location.href = window.location.pathname + '?updated=' + new Date().getTime();
                }
            }
        });

        document.getElementById('btnMostrarImportar').addEventListener('click', () => {
            document.getElementById('zonaImportacion').classList.remove('hidden');
        });

        document.addEventListener('DOMContentLoaded', () => {
            const datosGuardadosStr = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (datosGuardadosStr) {
                try {
                    const datosGuardados = JSON.parse(datosGuardadosStr);
                    if (datosGuardados.resultadosTabla && datosGuardados.resultadosTabla.length > 0) {
                        renderizarTablaYFiltros(datosGuardados);
                    }
                } catch (e) {
                    console.error("Error leyendo datos guardados", e);
                }
            }
        });
    </script>
</body>
</html>
